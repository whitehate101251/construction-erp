<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Construction ERP - Attendance</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="/js/session-manager.js"></script>
    <style>
        .attendance-card {
            margin-bottom: 20px;
        }
        .time-display {
            font-size: 1.2em;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h2 class="mb-4">Construction Site Attendance</h2>
        
        <!-- Site Selection -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Select Site</h5>
                <select id="siteSelect" class="form-select">
                    <option value="">Select a site...</option>
                </select>
            </div>
        </div>

        <!-- Worker Selection -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Select Worker</h5>
                <select id="workerSelect" class="form-select">
                    <option value="">Select a worker...</option>
                </select>
            </div>
        </div>

        <!-- Attendance Actions -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Mark Attendance</h5>
                <div class="d-flex gap-3">
                    <button id="markInBtn" class="btn btn-success">Mark In</button>
                    <button id="markOutBtn" class="btn btn-danger">Mark Out</button>
                </div>
            </div>
        </div>

        <!-- Today's Attendance -->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Today's Attendance</h5>
                <div id="attendanceList" class="list-group">
                    <!-- Attendance records will be displayed here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Base URL
        const API_URL = 'http://localhost:5000/api';

        // Authentication check
        function checkAuthentication() {
            // Get token from localStorage
            const token = localStorage.getItem('token');
            if (!token) {
                console.log('No token found, redirecting to login');
                window.location.href = '/login.html';
                return false;
            }
            
            // Check if token is expired
            try {
                // Get token expiry by decoding it
                const tokenData = JSON.parse(atob(token.split('.')[1]));
                const expiryTime = tokenData.exp * 1000; // Convert to milliseconds
                
                if (Date.now() > expiryTime) {
                    console.log('Token expired, redirecting to login');
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    window.location.href = '/login.html';
                    return false;
                }
                
                return true;
            } catch (error) {
                console.error('Invalid token format:', error);
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = '/login.html';
                return false;
            }
        }

        // Initialize the session manager
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication first
            if (!checkAuthentication()) {
                return; // Stop execution if not authenticated
            }
            
            // Initialize session manager
            sessionManager.init();
            
            // Check for multiple tabs
            sessionManager.notifyMultipleTabs();
            
            // Check again when the window gets focus
            window.addEventListener('focus', function() {
                sessionManager.notifyMultipleTabs();
                checkAuthentication(); // Re-check auth on focus
            });
            
            // Continue with normal initialization
            fetchSites();
        });

        // Fetch sites
        async function fetchSites() {
            try {
                const response = await fetch(`${API_URL}/sites`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                const sites = await response.json();
                const siteSelect = document.getElementById('siteSelect');
                sites.forEach(site => {
                    const option = document.createElement('option');
                    option.value = site._id;
                    option.textContent = site.name;
                    siteSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error fetching sites:', error);
            }
        }

        // Fetch workers for selected site
        async function fetchWorkers(siteId) {
            try {
                const response = await fetch(`${API_URL}/workers?siteId=${siteId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                const workers = await response.json();
                const workerSelect = document.getElementById('workerSelect');
                workerSelect.innerHTML = '<option value="">Select a worker...</option>';
                workers.forEach(worker => {
                    const option = document.createElement('option');
                    option.value = worker._id;
                    option.textContent = worker.name;
                    workerSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error fetching workers:', error);
            }
        }

        // Mark in time
        async function markInTime() {
            const workerId = document.getElementById('workerSelect').value;
            const siteId = document.getElementById('siteSelect').value;
            
            if (!workerId || !siteId) {
                alert('Please select both site and worker');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/attendance/mark-in`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ workerId, siteId })
                });
                const data = await response.json();
                if (response.ok) {
                    alert('In time marked successfully');
                    fetchTodayAttendance();
                } else {
                    alert(data.message);
                }
            } catch (error) {
                console.error('Error marking in time:', error);
                alert('Error marking in time');
            }
        }

        // Mark out time
        async function markOutTime() {
            const workerId = document.getElementById('workerSelect').value;
            
            if (!workerId) {
                alert('Please select a worker');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/attendance/mark-out`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ workerId })
                });
                const data = await response.json();
                if (response.ok) {
                    alert('Out time marked successfully');
                    fetchTodayAttendance();
                } else {
                    alert(data.message);
                }
            } catch (error) {
                console.error('Error marking out time:', error);
                alert('Error marking out time');
            }
        }

        // Fetch today's attendance
        async function fetchTodayAttendance() {
            const siteId = document.getElementById('siteSelect').value;
            if (!siteId) return;

            try {
                const response = await fetch(`${API_URL}/attendance/site/${siteId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                const attendance = await response.json();
                displayAttendance(attendance);
            } catch (error) {
                console.error('Error fetching attendance:', error);
            }
        }

        // Display attendance records
        function displayAttendance(records) {
            const attendanceList = document.getElementById('attendanceList');
            attendanceList.innerHTML = '';

            records.forEach(record => {
                const inTime = new Date(record.inTime).toLocaleTimeString();
                const outTime = record.outTime ? new Date(record.outTime).toLocaleTimeString() : 'Not marked';
                const workingHours = record.workingHours || '0';

                const item = document.createElement('div');
                item.className = 'list-group-item';
                item.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${record.worker.name}</h6>
                            <small>In: ${inTime} | Out: ${outTime}</small>
                        </div>
                        <span class="badge bg-primary">${workingHours} hours</span>
                    </div>
                `;
                attendanceList.appendChild(item);
            });
        }

        // Event Listeners
        document.getElementById('siteSelect').addEventListener('change', (e) => {
            if (e.target.value) {
                fetchWorkers(e.target.value);
                fetchTodayAttendance();
            }
        });

        document.getElementById('markInBtn').addEventListener('click', markInTime);
        document.getElementById('markOutBtn').addEventListener('click', markOutTime);
    </script>
</body>
</html> 